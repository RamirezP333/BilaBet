<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BilaBet - Bilawal FC Apuestas</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #004d3d; --accent: #c1ff00; --bg: #f0f4f2; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 15px; border: 2px solid var(--primary); width: 100%; max-width: 480px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        .status-gif { display: block; margin: 0 auto 15px auto; max-width: 220px; height: auto; border-radius: 12px; }

        input, button, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .btn-del { background: #ef4444; width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; }
        .hidden { display: none !important; }

        .admin-section { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left; border: 1px solid #cbd5e1; }
        .table-mini { width: 100%; font-size: 12px; border-collapse: collapse; background: white; margin-top: 10px; }
        .table-mini td { border: 1px solid #ddd; padding: 5px; text-align: center; }

        .info-table-user { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .info-table-user th { background: #fbc02d; padding: 8px; border: 1px solid #ddd; }
        .info-table-user td { padding: 8px; border: 1px solid #eee; text-align: center; background: #fff; }

        .am { background: #ffeb3b; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .ro { background: #f44336; color: white; font-weight: bold; padding: 2px 4px; border-radius: 3px; }
        .vote-box { background: #fffde7; padding: 10px; border-radius: 10px; border-left: 5px solid var(--primary); margin: 10px 0; text-align: left; }

        .admin-grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .small-help { font-size: 12px; color:#475569; margin-top:4px; }

        .status-pill {
            display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:bold; margin:6px 4px;
            border: 1px solid #cbd5e1; background:#f8fafc;
        }
        .status-open { background:#ecfdf5; color:#166534; border-color:#bbf7d0; }
        .status-closed { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
        .status-final { background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }

        .countdown {
            margin: 8px 0 12px;
            padding: 10px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .wallet {
            margin-top: 6px;
            display:inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #e2e8f0;
            background:#f8fafc;
            color:#0f172a;
            font-weight:700;
        }

        .ranking-row {
            display:flex; justify-content:space-between; align-items:center;
            gap:8px; padding:8px 6px; border-bottom:1px solid #eee;
            transition: transform .2s ease, background .2s ease;
            border-radius: 8px;
        }
        .ranking-row:hover { background:#f8fafc; transform: translateY(-1px); }
        .ranking-left { display:flex; align-items:center; gap:8px; min-width:0; }
        .ranking-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #0f172a; font-weight: 700; }
        .ranking-name-row { display: flex; align-items: center; gap: 6px; min-width: 0; }
        .ranking-name-row .ranking-name { flex: 1; min-width: 0; }
        .ranking-meta { display:flex; align-items:center; gap:6px; font-size:12px; color:#64748b; }
        .badge-medal { font-size:18px; width:24px; text-align:center; }
        .badge-streak {
            background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; border-radius:999px;
            padding:2px 6px; font-size:11px; font-weight:bold;
        }
        .arrow-up { color:#16a34a; font-weight:bold; }
        .arrow-down { color:#dc2626; font-weight:bold; }
        .arrow-same { color:#94a3b8; font-weight:bold; }

        .flash-up { animation: pulseUp 0.7s ease; }
        .flash-down { animation: pulseDown 0.7s ease; }
        @keyframes pulseUp {
            0% { background:#ecfdf5; transform:translateY(0); }
            50% { background:#dcfce7; transform:translateY(-2px); }
            100% { background:transparent; transform:translateY(0); }
        }
        @keyframes pulseDown {
            0% { background:#fef2f2; transform:translateY(0); }
            50% { background:#fee2e2; transform:translateY(-2px); }
            100% { background:transparent; transform:translateY(0); }
        }

        .checklist {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
        }
        .check-item {
            display:flex;
            align-items:center;
            gap:10px;
            padding:6px 4px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }
        .check-item:last-child { border-bottom: none; }
        .check-item input { width:auto; margin:0; transform: scale(1.1); }

        .pick-item{
            display:flex;
            align-items:center;
            gap:12px;
            padding:10px 8px;
            border-radius:10px;
            border:1px solid #e2e8f0;
            background:#ffffff;
            margin:8px 0;
            cursor:pointer;
            user-select:none;
        }
        .pick-item input{
            width:auto;
            margin:0;
            transform: scale(1.15);
            flex: 0 0 auto;
        }
        .pick-text{
            flex:1;
            min-width:0;
            line-height:1.2;
            word-break: break-word;
        }
    </style>
</head>
<body>

    <div id="auth-ui" class="card">
        <img src="bilalogo.jpeg" style="width:100%; border-radius:10px;">
        <input type="text" id="username" placeholder="@tu_instagram">
        <button onclick="entrar()">JUGAR</button>
        <button onclick="accesoAdmin()" style="background:#64748b; margin-top:10px; font-size:12px;">MODO ADMIN</button>
    </div>

    <div id="admin-ui" class="card hidden">
        <h3>üõ†Ô∏è PANEL ADMIN</h3>

        <div class="admin-section">
            <h4>1. Jugadores (Tabla de apoyo)</h4>

            <label style="font-size:13px; font-weight:bold;">Seleccionar jugador</label>
            <select id="adm-select-player" onchange="cargarPlayerSeleccionado()">
                <option value="">(Nuevo jugador)</option>
            </select>

            <input type="text" id="info-sujeto" placeholder="Jugador">
            <input type="text" id="info-goles" placeholder="Goles">
            <div style="display:flex; gap:5px;">
                <input type="number" id="info-am" placeholder="AM">
                <input type="number" id="info-ro" placeholder="RO">
            </div>

            <button onclick="guardarFila()" style="background:#22c55e">A√ëADIR / ACTUALIZAR</button>
            <button onclick="eliminarJugadorSeleccionado()" style="background:#ef4444">ELIMINAR JUGADOR</button>
        </div>

        <div class="admin-section">
            <h4>2. Usuarios (Ranking)</h4>

            <label style="font-size:13px; font-weight:bold;">Seleccionar usuario</label>
            <select id="adm-select-user" onchange="cargarUserSeleccionado()">
                <option value="">(Selecciona un usuario)</option>
            </select>

            <div class="admin-grid-2">
                <div>
                    <label style="font-size:13px; font-weight:bold;">Puntos</label>
                    <input type="number" id="adm-user-points" placeholder="Pts">
                </div>
                <div>
                    <label style="font-size:13px; font-weight:bold;">Cr√©ditos</label>
                    <input type="number" id="adm-user-credits" placeholder="Cr√©ditos" disabled>
                </div>
            </div>

            <!-- ‚úÖ NUEVO: modificar racha -->
            <div class="admin-grid-2">
                <div>
                    <label style="font-size:13px; font-weight:bold;">Racha actual</label>
                    <input type="number" id="adm-user-streak" placeholder="Racha">
                </div>
                <div>
                    <label style="font-size:13px; font-weight:bold;">Mejor racha</label>
                    <input type="number" id="adm-user-beststreak" placeholder="Mejor racha">
                </div>
            </div>

            <button onclick="actualizarUsuarioAdmin()" style="background:#2563eb">ACTUALIZAR (PTS + RACHA)</button>
            <button onclick="eliminarUsuarioSeleccionado()" style="background:#ef4444">ELIMINAR USUARIO</button>
        </div>

        <div class="admin-section">
            <h4>3. Cr√©ditos semanales</h4>
            <div class="small-help">Permite que los usuarios recojan sus cr√©ditos (solo si tienen 0). Si tienen racha (>=2) recibir√°n 6.</div>
            <button onclick="habilitarEntregaCreditos()" style="background:#0ea5e9">HABILITAR ENTREGA DE CR√âDITOS</button>
        </div>

        <div class="admin-section">
            <h4>4. Ronda (+1 y +3)</h4>

            <div class="admin-grid-2">
                <div>
                    <label for="adm-cierre-fecha" style="font-size:13px; font-weight:bold;">üìÖ Fecha cierre</label>
                    <input type="date" id="adm-cierre-fecha">
                </div>
                <div>
                    <label for="adm-cierre-hora" style="font-size:13px; font-weight:bold;">‚è∞ Hora cierre</label>
                    <input type="time" id="adm-cierre-hora">
                </div>
            </div>
            <div class="small-help">La votaci√≥n se cerrar√° autom√°ticamente en esa fecha/hora (hora local del dispositivo).</div>

            <textarea id="adm-o2" placeholder="Opciones 1 PTO (Ej: Messi, Cristiano)"></textarea>
            <textarea id="adm-o3" placeholder="Opciones 3 PTOS (Ej: 2-1, 3-0)"></textarea>
            <button onclick="lanzar()" style="background:#2563eb">ACTIVAR RONDA</button>
        </div>

        <div class="admin-section">
            <h4>5. Validar ganadores (checkbox)</h4>
            <div class="small-help">Se cargan autom√°ticamente desde la ronda activa. Marca los correctos y valida.</div>

            <div style="margin-top:10px; font-weight:bold;">Vale 1 punto</div>
            <div id="adm-win2-list" class="checklist"></div>

            <div style="margin-top:10px; font-weight:bold;">Vale 3 puntos</div>
            <div id="adm-win3-list" class="checklist"></div>

            <button onclick="puntuar()" style="background:#f59e0b; margin-top:12px;">VALIDAR GANADORES</button>
        </div>

        <button onclick="location.reload()" style="background:black">CERRAR PANEL</button>
    </div>

    <div id="game-ui" class="card hidden">
        <img id="display-gif" src="Bilawal.jpeg" class="status-gif">
        <h3 id="user-display"></h3>
        <div id="wallet-display" class="wallet">üíº 0 cr√©ditos</div>

        <button id="btn-recoger-creditos" class="hidden" onclick="recogerCreditos()" style="background:#0ea5e9; margin-top:10px;">
            RECOGER CR√âDITOS
        </button>

        <div id="estado-ronda-box" style="margin-bottom:10px;"></div>
        <div id="countdown-box" class="countdown hidden"></div>

        <div class="card" style="border:none; background:#fffde7; padding:10px; width:100%; margin:0;">
            <h4>üìä ESTAD√çSTICAS</h4>
            <table class="info-table-user">
                <thead>
                    <tr><th rowspan="2">JUGADOR</th><th rowspan="2">GOL</th><th colspan="2">TARJETAS</th></tr>
                    <tr><th style="background:#ffeb3b">AM</th><th style="background:#f44336; color:white">RO</th></tr>
                </thead>
                <tbody id="info-content-user"></tbody>
            </table>
        </div>

        <div id="votos-ui">
            <div class="vote-box"><strong>VALE 1 PUNTO:</strong><div id="render-o2"></div></div>
            <div class="vote-box"><strong>VALE 3 PUNTOS:</strong><div id="render-o3"></div></div>
            <button id="btn-votar" onclick="votar()" class="hidden" style="background:#22c55e">ENVIAR APUESTA</button>
        </div>

        <div style="margin-top:20px;">
            <h4>üèÜ RANKING</h4>
            <div style="font-size:12px; color:#64748b; margin-top:-4px; margin-bottom:8px;">
                Jugadores con racha (>=2) reciben +1 cr√©dito extra esa semana.
            </div>
            <div id="ranking-list"></div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://hhkplxfousaoyjfpnllo.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhoa3BseGZvdXNhb3lqZnBubGxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4Njc4NTMsImV4cCI6MjA4NzQ0Mzg1M30.SPbJIeYBRm9yBdIZPXh3HSM88k73McLZIAzfhMZWEj0';
        const { createClient } = supabase;
        const sb = createClient(SB_URL, SB_KEY);

        let miNombre = "";
        let esAdmin = false;
        const IMAGEN_ESTADO = "Bilawal.jpeg";

        let refreshIntervalId = null;
        let countdownIntervalId = null;
        let realtimeChannel = null;

        let __statsCache = [];
        let __usersCache = [];

        // --- Anti-desmarcado (1 minuto) ---
        let userIsSelecting = false;
        let adminIsSelecting = false;
        let __userSelectTimer = null;
        let __adminSelectTimer = null;

        function bumpUserSelecting() {
          userIsSelecting = true;
          if (__userSelectTimer) clearTimeout(__userSelectTimer);
          __userSelectTimer = setTimeout(() => { userIsSelecting = false; }, 60000);
        }
        function bumpAdminSelecting() {
          adminIsSelecting = true;
          if (__adminSelectTimer) clearTimeout(__adminSelectTimer);
          __adminSelectTimer = setTimeout(() => { adminIsSelecting = false; }, 60000);
        }
        function setupSelectionGuards() {
          const votosUI = document.getElementById('votos-ui');
          if (votosUI && !votosUI.__guardsAttached) {
            votosUI.__guardsAttached = true;
            votosUI.addEventListener('change', (e) => {
              if (e.target && (e.target.name === 'c2' || e.target.name === 'c3')) bumpUserSelecting();
            });
          }
          const adminUI = document.getElementById('admin-ui');
          if (adminUI && !adminUI.__guardsAttached) {
            adminUI.__guardsAttached = true;
            adminUI.addEventListener('change', (e) => {
              if (e.target && (e.target.name === 'admwin2' || e.target.name === 'admwin3')) bumpAdminSelecting();
            });
          }
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function splitOpciones(txt) {
            return (txt || "").split(',').map(x => x.trim()).filter(Boolean);
        }

        function parseCierreLocalToISO(fecha, hora) {
            if (!fecha || !hora) return null;
            const d = new Date(`${fecha}T${hora}:00`);
            if (isNaN(d.getTime())) return null;
            return d.toISOString();
        }

        function formatFechaHora(iso) {
            if (!iso) return "No definida";
            const d = new Date(iso);
            if (isNaN(d.getTime())) return "No definida";
            return d.toLocaleString('es-ES', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getEstadoRondaVisual(jg) {
            const ahora = Date.now();
            const cierreMs = jg?.cierre_votacion ? new Date(jg.cierre_votacion).getTime() : null;

            if (!jg || (!jg.opciones2?.length && !jg.opciones3?.length)) return { txt: 'Sin ronda activa', cls: '' };
            if (jg.ronda_id === 1) return { txt: `Ronda ${jg.ronda_num || 0} finalizada`, cls: 'status-final' };
            if (cierreMs && ahora >= cierreMs) return { txt: `Ronda ${jg.ronda_num || 0} cerrada (pendiente validar)`, cls: 'status-closed' };
            return { txt: `Ronda ${jg.ronda_num || 0} abierta`, cls: 'status-open' };
        }

        function estaVotacionCerrada(jg) {
            if (!jg) return true;
            if (jg.ronda_id === 1) return true;
            if (!jg.cierre_votacion) return false;
            return Date.now() >= new Date(jg.cierre_votacion).getTime();
        }

        function renderCountdown(jg) {
            const box = document.getElementById('countdown-box');
            if (!jg || jg.ronda_id === 1 || !jg.cierre_votacion) {
                box.classList.add('hidden');
                box.innerHTML = '';
                return;
            }
            const cierre = new Date(jg.cierre_votacion).getTime();
            const ahora = Date.now();
            const diff = cierre - ahora;

            if (diff <= 0) {
                box.classList.remove('hidden');
                box.innerHTML = `‚õî La votaci√≥n se ha cerrado.`;
                return;
            }

            const totalSec = Math.floor(diff / 1000);
            const dias = Math.floor(totalSec / 86400);
            const horas = Math.floor((totalSec % 86400) / 3600);
            const min = Math.floor((totalSec % 3600) / 60);
            const sec = totalSec % 60;

            box.classList.remove('hidden');
            box.innerHTML = `‚è≥ Cierre de votaci√≥n: <b>${formatFechaHora(jg.cierre_votacion)}</b><br>
                             Tiempo restante: <b>${dias}d ${horas}h ${min}m ${sec}s</b>`;
        }

        function startCountdownUpdater() {
            if (countdownIntervalId) clearInterval(countdownIntervalId);
            countdownIntervalId = setInterval(() => {
                if (window.__lastEstadoJuego) renderCountdown(window.__lastEstadoJuego);
            }, 1000);
        }

        function getRankingWithPositions(rk) {
            return rk.map((j, idx) => ({ ...j, _pos: idx + 1 }));
        }

        function getMedalByTies(rk) {
            const uniquePoints = [];
            for (const j of rk) if (!uniquePoints.includes(j.puntos)) uniquePoints.push(j.puntos);

            const medalByPoints = {};
            if (uniquePoints.length > 0) medalByPoints[uniquePoints[0]] = 'ü•á';
            if (uniquePoints.length > 1) medalByPoints[uniquePoints[1]] = 'ü•à';
            if (uniquePoints.length > 2) medalByPoints[uniquePoints[2]] = 'ü•â';

            const map = {};
            for (const j of rk) map[j.nombre] = medalByPoints[j.puntos] || '';
            return map;
        }

        function getRankingArrowMap(rk) {
            const keyPrev = 'bilabet_ranking_prev_map';
            const keyCurr = 'bilabet_ranking_curr_map';
            const keySig = 'bilabet_ranking_sig';

            const currentMap = {};
            rk.forEach((j, i) => currentMap[j.nombre] = i + 1);

            const currentSig = rk.map(j => `${j.nombre}:${j.puntos}`).join('|');
            const storedSig = localStorage.getItem(keySig);

            let prevMap = {};
            try { prevMap = JSON.parse(localStorage.getItem(keyPrev) || '{}'); } catch { prevMap = {}; }

            if (storedSig !== currentSig) {
                let oldCurr = {};
                try { oldCurr = JSON.parse(localStorage.getItem(keyCurr) || '{}'); } catch { oldCurr = {}; }

                localStorage.setItem(keyPrev, JSON.stringify(oldCurr));
                localStorage.setItem(keyCurr, JSON.stringify(currentMap));
                localStorage.setItem(keySig, currentSig);

                prevMap = oldCurr;
            }

            const arrows = {};
            for (const j of rk) {
                const nowPos = currentMap[j.nombre];
                const prevPos = prevMap[j.nombre];

                if (!prevPos) {
                    arrows[j.nombre] = { txt: '', cls: 'arrow-same', flash: '' };
                } else if (nowPos < prevPos) {
                    arrows[j.nombre] = { txt: `‚ñ≤ ${prevPos - nowPos}`, cls: 'arrow-up', flash: 'flash-up' };
                } else if (nowPos > prevPos) {
                    arrows[j.nombre] = { txt: `‚ñº ${nowPos - prevPos}`, cls: 'arrow-down', flash: 'flash-down' };
                } else {
                    arrows[j.nombre] = { txt: '', cls: 'arrow-same', flash: '' };
                }
            }
            return arrows;
        }

        function renderRanking(rk) {
            const list = document.getElementById('ranking-list');
            const conPos = getRankingWithPositions(rk);
            const medalMap = getMedalByTies(conPos);
            const arrowMap = getRankingArrowMap(conPos);

            list.innerHTML = conPos.map(j => {
                const medal = medalMap[j.nombre] || '';
                const arrow = arrowMap[j.nombre] || { txt: '', cls: 'arrow-same', flash: '' };
                const streakBadge = (j.racha_actual >= 2) ? `<span class="badge-streak">üî• ${j.racha_actual}</span>` : '';

                return `
                    <div class="ranking-row ${arrow.flash}">
                        <div class="ranking-left">
                            <span class="badge-medal">${medal || ''}</span>
                            <div style="min-width:0;">
                                <div class="ranking-name-row">
                                    <div class="ranking-name">@${escapeHtml(j.nombre)}</div>
                                    ${streakBadge}
                                </div>
                                <div class="ranking-meta">
                                    ${arrow.txt ? `<span class="${arrow.cls}">${arrow.txt}</span>` : ``}
                                </div>
                            </div>
                        </div>
                        <div><b>${j.puntos} Pts</b></div>
                    </div>
                `;
            }).join('');
        }

        function actualizarSelectsAdmin() {
            if (!esAdmin) return;

            const selP = document.getElementById('adm-select-player');
            const currentP = selP.value;
            selP.innerHTML = `<option value="">(Nuevo jugador)</option>` + __statsCache
                .map(s => `<option value="${escapeHtml(s.sujeto)}">${escapeHtml(s.sujeto)}</option>`).join('');
            selP.value = currentP || '';

            const selU = document.getElementById('adm-select-user');
            const currentU = selU.value;
            selU.innerHTML = `<option value="">(Selecciona un usuario)</option>` + __usersCache
                .map(u => `<option value="${escapeHtml(u.nombre)}">@${escapeHtml(u.nombre)}</option>`).join('');
            selU.value = currentU || '';
        }

        function cargarPlayerSeleccionado() {
            const sujeto = document.getElementById('adm-select-player').value;
            if (!sujeto) {
                document.getElementById('info-sujeto').value = "";
                document.getElementById('info-goles').value = "";
                document.getElementById('info-am').value = "";
                document.getElementById('info-ro').value = "";
                return;
            }
            const row = __statsCache.find(x => x.sujeto === sujeto);
            if (!row) return;
            document.getElementById('info-sujeto').value = row.sujeto || "";
            document.getElementById('info-goles').value = row.dato1 || "";
            document.getElementById('info-am').value = row.dato2 ?? 0;
            document.getElementById('info-ro').value = row.dato3 ?? 0;
        }

        function cargarUserSeleccionado() {
            const nom = document.getElementById('adm-select-user').value;
            const u = __usersCache.find(x => x.nombre === nom);
            if (!u) {
                document.getElementById('adm-user-points').value = "";
                document.getElementById('adm-user-credits').value = "";
                document.getElementById('adm-user-streak').value = "";
                document.getElementById('adm-user-beststreak').value = "";
                return;
            }
            document.getElementById('adm-user-points').value = u.puntos ?? 0;
            document.getElementById('adm-user-credits').value = u.creditos ?? 0;
            document.getElementById('adm-user-streak').value = u.racha_actual ?? 0;
            document.getElementById('adm-user-beststreak').value = u.mejor_racha ?? 0;
        }

        async function eliminarJugadorSeleccionado() {
            const sujeto = document.getElementById('adm-select-player').value;
            if (!sujeto) return alert("Selecciona un jugador.");
            if (!confirm(`¬øEliminar al jugador "${sujeto}" de la tabla de apoyo?`)) return;

            const { error } = await sb.from('estadisticas').delete().eq('sujeto', sujeto);
            if (error) { console.error(error); return alert("Error eliminando jugador."); }
            alert("Jugador eliminado ‚úÖ");
            document.getElementById('adm-select-player').value = "";
            cargarPlayerSeleccionado();
            refrescar();
        }

        async function eliminarUsuarioSeleccionado() {
            const nom = document.getElementById('adm-select-user').value;
            if (!nom) return alert("Selecciona un usuario.");
            if (!confirm(`¬øEliminar al usuario "@${nom}" del sistema?`)) return;

            const { error } = await sb.from('jugadores').delete().eq('nombre', nom);
            if (error) { console.error(error); return alert("Error eliminando usuario."); }
            alert("Usuario eliminado ‚úÖ");
            document.getElementById('adm-select-user').value = "";
            cargarUserSeleccionado();
            refrescar();
        }

        async function actualizarUsuarioAdmin() {
            const nom = document.getElementById('adm-select-user').value;
            if (!nom) return alert("Selecciona un usuario.");

            const pts = parseInt(document.getElementById('adm-user-points').value, 10);
            const racha = parseInt(document.getElementById('adm-user-streak').value, 10);
            const mejor = parseInt(document.getElementById('adm-user-beststreak').value, 10);

            if (Number.isNaN(pts) || pts < 0) return alert("Puntos inv√°lidos.");
            if (Number.isNaN(racha) || racha < 0) return alert("Racha inv√°lida.");
            if (Number.isNaN(mejor) || mejor < 0) return alert("Mejor racha inv√°lida.");

            const mejorFinal = Math.max(mejor, racha);

            const { error } = await sb.from('jugadores').update({
                puntos: pts,
                racha_actual: racha,
                mejor_racha: mejorFinal
            }).eq('nombre', nom);

            if (error) { console.error(error); return alert("Error actualizando usuario."); }

            alert("Usuario actualizado ‚úÖ");
            refrescar();
        }

        async function habilitarEntregaCreditos() {
            const { error } = await sb.from('estado_juego').update({ creditos_habilitados: true }).eq('id', 1);
            if (error) { console.error(error); return alert("Error habilitando entrega de cr√©ditos."); }
            alert("Entrega de cr√©ditos habilitada ‚úÖ");
            refrescar();
        }

        function renderAdminValidacion(jg) {
            const box2 = document.getElementById('adm-win2-list');
            const box3 = document.getElementById('adm-win3-list');
            if (!esAdmin) return;

            if (!jg || (!jg.opciones2?.length && !jg.opciones3?.length)) {
                box2.innerHTML = `<div style="font-size:12px; color:#64748b;">No hay ronda activa.</div>`;
                box3.innerHTML = `<div style="font-size:12px; color:#64748b;">No hay ronda activa.</div>`;
                return;
            }

            box2.innerHTML = (jg.opciones2 || []).map((o) => `
                <label class="check-item">
                    <input type="checkbox" name="admwin2" value="${escapeHtml(o)}">
                    <span>${escapeHtml(o)}</span>
                </label>
            `).join('') || `<div style="font-size:12px; color:#64748b;">Sin opciones.</div>`;

            box3.innerHTML = (jg.opciones3 || []).map((o) => `
                <label class="check-item">
                    <input type="checkbox" name="admwin3" value="${escapeHtml(o)}">
                    <span>${escapeHtml(o)}</span>
                </label>
            `).join('') || `<div style="font-size:12px; color:#64748b;">Sin opciones.</div>`;
        }

        async function entrar() {
          miNombre = document.getElementById('username').value.trim().toLowerCase().replace('@','');
          if(!miNombre) return;

          const { error } = await sb.from('jugadores')
            .upsert({ nombre: miNombre }, { onConflict: 'nombre' });

          if (error) {
            console.error("Error entrar:", error);
            alert(`Error al entrar:\n${error.message || error}\n\nCode: ${error.code || ''}`);
            return;
          }

          document.getElementById('auth-ui').classList.add('hidden');
          document.getElementById('game-ui').classList.remove('hidden');
          document.getElementById('user-display').innerText = "@" + miNombre;
          iniciar();
        }

        function accesoAdmin() {
            if(prompt("Clave:") === "trusttheblan") {
                esAdmin = true;
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('game-ui').classList.remove('hidden');

                const now = new Date();
                now.setHours(now.getHours() + 1);
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const mi = String(now.getMinutes()).padStart(2, '0');
                const fechaInp = document.getElementById('adm-cierre-fecha');
                const horaInp = document.getElementById('adm-cierre-hora');
                if (fechaInp && !fechaInp.value) fechaInp.value = `${yyyy}-${mm}-${dd}`;
                if (horaInp && !horaInp.value) horaInp.value = `${hh}:${mi}`;

                iniciar();
            }
        }

        async function guardarFila() {
            const s = document.getElementById('info-sujeto').value.trim();
            const g = document.getElementById('info-goles').value;
            const a = document.getElementById('info-am').value || 0;
            const r = document.getElementById('info-ro').value || 0;
            if(!s) return alert("Nombre obligatorio");

            const { error } = await sb.from('estadisticas').upsert(
                { sujeto: s, dato1: g, dato2: a, dato3: r },
                { onConflict: 'sujeto' }
            );
            if (error) { console.error(error); return alert("Error guardando jugador."); }

            alert("Guardado ‚úÖ");
            document.getElementById('adm-select-player').value = s;
            refrescar();
        }

        async function recogerCreditos() {
            const { data: yo, error: eYo } = await sb.from('jugadores').select('*').eq('nombre', miNombre).single();
            if (eYo) { console.error(eYo); return alert("Error leyendo tu usuario."); }

            if ((yo?.creditos ?? 0) > 0) return alert("Ya tienes cr√©ditos. Primero g√°stalos.");
            if (yo?.seleccion2 || yo?.seleccion3) return alert("Ya has enviado tu apuesta esta semana. No puedes recoger cr√©ditos ahora.");

            const { data: jg, error: eJg } = await sb.from('estado_juego').select('creditos_habilitados').eq('id',1).single();
            if (eJg) { console.error(eJg); return alert("Error comprobando entrega de cr√©ditos."); }
            if (!jg?.creditos_habilitados) return alert("La entrega de cr√©ditos no est√° habilitada.");

            const racha = yo?.racha_actual ?? 0;
            const cantidad = (racha >= 2) ? 6 : 5;

            const { error } = await sb.from('jugadores').update({ creditos: cantidad }).eq('nombre', miNombre);
            if (error) { console.error(error); return alert("Error recogiendo cr√©ditos."); }

            alert(`Has recogido ${cantidad} cr√©ditos ‚úÖ`);
            refrescar();
        }

        async function refrescar() {
            const [{ data: st, error: e1 }, { data: rk, error: e2 }, { data: jg, error: e3 }, { data: yo, error: e4 }] = await Promise.all([
                sb.from('estadisticas').select('*').order('sujeto'),
                sb.from('jugadores').select('*').order('puntos', { ascending: false }).order('nombre', { ascending: true }),
                sb.from('estado_juego').select('*').eq('id', 1).single(),
                miNombre ? sb.from('jugadores').select('*').eq('nombre', miNombre).single() : Promise.resolve({ data: null, error: null })
            ]);

            if (e1 || e2 || e3 || e4) console.error("Errores refrescar:", e1, e2, e3, e4);

            window.__lastEstadoJuego = jg || null;

            __statsCache = st || [];
            __usersCache = rk || [];
            actualizarSelectsAdmin();

            if (!adminIsSelecting) renderAdminValidacion(jg || null);

            document.getElementById('info-content-user').innerHTML = (__statsCache || []).map(s =>
                `<tr>
                    <td><b>${escapeHtml(s.sujeto)}</b></td>
                    <td>${escapeHtml(s.dato1)}</td>
                    <td><span class="am">${escapeHtml(s.dato2)}</span></td>
                    <td><span class="ro">${escapeHtml(s.dato3)}</span></td>
                </tr>`
            ).join('');

            const wallet = document.getElementById('wallet-display');
            const btnCred = document.getElementById('btn-recoger-creditos');
            const myCredits = yo?.creditos ?? 0;
            wallet.textContent = `üíº ${myCredits} cr√©ditos`;

            const creditosHabilitados = !!jg?.creditos_habilitados;
            const noHaApostado = !(yo?.seleccion2 || yo?.seleccion3);

            if (creditosHabilitados && myCredits === 0 && noHaApostado) btnCred.classList.remove('hidden');
            else btnCred.classList.add('hidden');

            const r2 = document.getElementById('render-o2');
            const r3 = document.getElementById('render-o3');
            const btn = document.getElementById('btn-votar');
            const estadoBox = document.getElementById('estado-ronda-box');

            const ev = getEstadoRondaVisual(jg || {});
            estadoBox.innerHTML = `<span class="status-pill ${ev.cls}">${ev.txt}</span>`;
            renderCountdown(jg || {});

            if (jg) {
                if (jg.ronda_id === 1) {
                    r2.innerHTML = `Ganadores (+1): <b>${escapeHtml(jg.correcta2 || '-')}</b>`;
                    r3.innerHTML = `Ganadores (+3): <b>${escapeHtml(jg.correcta3 || '-')}</b>`;
                    btn.classList.add('hidden');
                } else if ((jg.opciones2?.length > 0 || jg.opciones3?.length > 0)) {
                    const cerrada = estaVotacionCerrada(jg);

                    if (!yo?.seleccion2 && !cerrada) {
                        btn.classList.remove('hidden');

                        if (!userIsSelecting) {
                            r2.innerHTML = (jg.opciones2 || []).map(o =>
                                `<label class="pick-item">
                                    <input type="radio" name="c2" value="${escapeHtml(o)}">
                                    <span class="pick-text">${escapeHtml(o)}</span>
                                 </label>`
                            ).join('');

                            r3.innerHTML = (jg.opciones3 || []).map(o =>
                                `<label class="pick-item">
                                    <input type="radio" name="c3" value="${escapeHtml(o)}">
                                    <span class="pick-text">${escapeHtml(o)}</span>
                                 </label>`
                            ).join('');
                        }
                    } else if (!yo?.seleccion2 && cerrada) {
                        r2.innerHTML = `‚õî Votaci√≥n cerrada (${formatFechaHora(jg.cierre_votacion)})`;
                        r3.innerHTML = `Esperando validaci√≥n del admin...`;
                        btn.classList.add('hidden');
                    } else {
                        const b2 = yo?.apuesta2 ?? 0;
                        const b3 = yo?.apuesta3 ?? 0;
                        const sel2 = yo?.seleccion2 ?? '-';
                        const sel3 = yo?.seleccion3 ?? '-';

                        r2.innerHTML = `‚úÖ Apuesta enviada<br>
                                        Tu elecci√≥n: <b>${escapeHtml(sel2)}</b><br>
                                        Cr√©ditos apostados: <b>${b2}</b><br>
                                        Ganancia potencial: <b>${b2 * 1}</b> pts`;

                        r3.innerHTML = `‚úÖ Apuesta enviada<br>
                                        Tu elecci√≥n: <b>${escapeHtml(sel3)}</b><br>
                                        Cr√©ditos apostados: <b>${b3}</b><br>
                                        Ganancia potencial: <b>${b3 * 3}</b> pts`;

                        btn.classList.add('hidden');

                        userIsSelecting = false;
                        if (__userSelectTimer) clearTimeout(__userSelectTimer);
                    }
                } else {
                    r2.innerHTML = "No hay ronda activa";
                    r3.innerHTML = "";
                    btn.classList.add('hidden');
                }
            }

            renderRanking(rk || []);
        }

        async function lanzar() {
            const o2 = splitOpciones(document.getElementById('adm-o2').value);
            const o3 = splitOpciones(document.getElementById('adm-o3').value);
            if (o2.length === 0 && o3.length === 0) return alert("A√±ade opciones para la ronda.");

            const fechaCierre = document.getElementById('adm-cierre-fecha').value;
            const horaCierre = document.getElementById('adm-cierre-hora').value;
            const cierreISO = parseCierreLocalToISO(fechaCierre, horaCierre);
            if (!cierreISO) return alert("Debes indicar fecha y hora de cierre v√°lidas.");

            const { data: estadoActual, error: eGet } = await sb.from('estado_juego').select('ronda_num').eq('id', 1).single();
            if (eGet) { console.error(eGet); return alert("Error leyendo estado actual."); }

            const nuevaRondaNum = (estadoActual?.ronda_num || 0) + 1;

            const { error: e1 } = await sb.from('estado_juego')
                .update({
                    opciones2: o2,
                    opciones3: o3,
                    correcta2: null,
                    correcta3: null,
                    ronda_id: 0,
                    ronda_num: nuevaRondaNum,
                    cierre_votacion: cierreISO,
                })
                .eq('id', 1);

            if (e1) { console.error(e1); return alert("Error activando ronda."); }

            const { error: e2 } = await sb.from('jugadores').update({
                seleccion2: null,
                seleccion3: null,
                apuesta2: 0,
                apuesta3: 0
            }).neq('nombre','');

            if (e2) { console.error(e2); return alert("Ronda creada, pero error al limpiar selecciones."); }

            userIsSelecting = false;
            adminIsSelecting = false;
            if (__userSelectTimer) clearTimeout(__userSelectTimer);
            if (__adminSelectTimer) clearTimeout(__adminSelectTimer);

            alert(`Ronda ${nuevaRondaNum} iniciada.\nCierre: ${formatFechaHora(cierreISO)}\nRecuerda habilitar cr√©ditos.`);
        }

        async function votar() {
            const v2 = document.querySelector('input[name="c2"]:checked')?.value;
            const v3 = document.querySelector('input[name="c3"]:checked')?.value;
            if(!v2 || !v3) return alert("Elige ambas opciones");

            const { data: jg, error: eJg } = await sb.from('estado_juego').select('*').eq('id', 1).single();
            if (eJg) { console.error(eJg); return alert("Error comprobando estado de la ronda."); }
            if (estaVotacionCerrada(jg)) return alert("La votaci√≥n est√° cerrada.");

            const { data: yo, error: eYo } = await sb.from('jugadores').select('*').eq('nombre', miNombre).single();
            if (eYo) { console.error(eYo); return alert("Error leyendo tu usuario."); }

            const credits = yo?.creditos ?? 0;
            if (credits === 0) return alert("No tienes cr√©ditos. Si el admin habilit√≥ la entrega, pulsa 'Recoger cr√©ditos'.");
            if (credits !== 5 && credits !== 6) return alert("Tus cr√©ditos deben ser 5 o 6 para apostar esta semana.");

            const total = credits;
            let bet1 = prompt(`¬øCu√°ntos cr√©ditos apuestas al pron√≥stico de 1 punto? (m√≠n 1, m√°x ${total - 1})`);
            if (bet1 === null) return;
            bet1 = parseInt(bet1, 10);
            if (Number.isNaN(bet1) || bet1 < 1 || bet1 > (total - 1)) return alert(`Debe ser un n√∫mero entre 1 y ${total - 1}.`);

            const bet3 = total - bet1;
            if (bet3 < 1) return alert("Debes apostar al menos 1 cr√©dito al pron√≥stico de 3 puntos.");

            const ok = confirm(`Confirmar apuesta:\n- 1 punto: ${bet1} cr√©ditos (potencial: ${bet1 * 1} pts)\n- 3 puntos: ${bet3} cr√©ditos (potencial: ${bet3 * 3} pts)\nTotal: ${total}`);
            if (!ok) return;

            const { error } = await sb.from('jugadores').update({
                seleccion2: v2,
                seleccion3: v3,
                apuesta2: bet1,
                apuesta3: bet3,
                creditos: 0
            }).eq('nombre', miNombre);

            if (error) { console.error(error); return alert("Error al enviar apuesta."); }

            userIsSelecting = false;
            if (__userSelectTimer) clearTimeout(__userSelectTimer);
        }

        async function puntuar() {
            const w2 = Array.from(document.querySelectorAll('input[name="admwin2"]:checked')).map(x => x.value);
            const w3 = Array.from(document.querySelectorAll('input[name="admwin3"]:checked')).map(x => x.value);

            const { data: jg, error: eJg } = await sb.from('estado_juego').select('*').eq('id', 1).single();
            if (eJg) { console.error(eJg); return alert("Error leyendo estado de ronda."); }

            if (jg && jg.cierre_votacion && Date.now() < new Date(jg.cierre_votacion).getTime()) {
                const seguir = confirm("La votaci√≥n todav√≠a est√° abierta. ¬øQuieres validar igualmente?");
                if (!seguir) return;
            }

            const { error } = await sb.rpc('validar_y_puntuar', { c2: w2, c3: w3 });
            if (error) {
                console.error("RPC validar_y_puntuar error:", error);
                return alert(`Error validando ganadores: ${error.message}`);
            }

            const { error: eCut } = await sb.from('estado_juego')
              .update({ creditos_habilitados: false })
              .eq('id', 1);
            if (eCut) console.error("Error deshabilitando cr√©ditos:", eCut);

            adminIsSelecting = false;
            if (__adminSelectTimer) clearTimeout(__adminSelectTimer);

            alert("Ganadores validados ‚úÖ (puntos por apuestas + racha actualizada)");
        }

        function iniciar() {
            if (!realtimeChannel) {
                realtimeChannel = sb.channel('db')
                    .on('postgres_changes', { event: '*', schema: 'public' }, () => refrescar())
                    .subscribe();
            }
            if (!refreshIntervalId) refreshIntervalId = setInterval(refrescar, 5000);
            startCountdownUpdater();
            setupSelectionGuards();
            refrescar();
        }
    </script>
</body>
</html>
